<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Academic Lexicon Suite v20.2 // OVERRIDE APEX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net"></script>
    <style>
        @import url('https://fonts.googleapis.com');
        :root { --gold: #f3c623; --red: #ff003c; --neon: #00f3ff; --bg: #050505; }
        body { background: #000; color: #fff; font-family: 'Space Mono', monospace; overflow: hidden; margin: 0; }
        
        /* „Çµ„Ç§„Éê„Éº„Éë„É≥„ÇØ„Éª„Éè„Ç§„Ç®„É≥„Éâ„Éá„Ç∂„Ç§„É≥ */
        .glass { background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .screen { display: none; height: 100dvh; width: 100%; position: fixed; flex-direction: column; z-index: 100; }
        .screen.active { display: flex; animation: k-fade 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes k-fade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .post-box { 
            background: rgba(15, 15, 15, 0.9); border-left: 4px solid var(--gold); 
            padding: 1.5rem; margin-bottom: 1rem; border-radius: 4px 16px 16px 4px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.8); transition: 0.3s ease; position: relative;
        }
        .post-box:hover { transform: translateX(5px); border-left-color: var(--neon); }
        .admin-mode { border-left-color: var(--red) !important; background: linear-gradient(90deg, rgba(50,0,0,0.4), #0a0a0a); }
        
        #feed { flex: 1; overflow-y: auto; padding: 2rem; scroll-behavior: smooth; }
        #feed::-webkit-scrollbar { width: 3px; }
        #feed::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; }

        .btn-apex { background: var(--gold); color: #000; font-weight: 900; cursor: pointer; transition: 0.3s; letter-spacing: 2px; }
        .btn-apex:hover { background: #fff; box-shadow: 0 0 20px var(--gold); transform: translateY(-2px); }
        .btn-apex:active { transform: translateY(1px); }
        .glitch { text-shadow: 2px 0 var(--red), -2px 0 var(--neon); }
    </style>
</head>
<body>

    <!-- 1: GATEWAY (Pass: neba72) - Â≠¶Ê†°„Éï„Ç£„É´„ÇøÂõûÈÅøÁî®ÂÅΩË£Ö -->
    <div id="scr-1" class="screen active bg-white items-center justify-center p-10">
        <div class="max-w-md w-full text-center">
            <h1 class="text-5xl font-black text-black italic mb-2 tracking-tighter glitch">Constraint</h1>
            <p class="text-[10px] text-zinc-400 font-bold mb-12 tracking-[0.5em] uppercase">Academic Lexicon Management v20.2</p>
            <input type="password" id="gate-in" class="w-full bg-zinc-100 p-6 rounded-2xl text-center text-3xl font-bold text-black border-none outline-none mb-6 shadow-inner" placeholder="STUDENT_ID">
            <button onclick="valGate()" class="w-full bg-black text-white p-6 rounded-2xl font-black tracking-[0.3em] shadow-2xl active:scale-95 transition-all">SIGN_IN</button>
        </div>
    </div>

    <!-- 2: APEX LOUNGE (Main Interface) -->
    <div id="scr-2" class="screen bg-[#050505]">
        <header class="h-20 border-b border-zinc-900 flex justify-between items-center px-8 glass z-50">
            <div class="flex flex-col">
                <h1 class="text-xl font-black text-[#f3c623] italic tracking-widest" style="font-family:'Orbitron'">OVERRIDE_ZENITH</h1>
                <div id="typing" class="text-[7px] text-green-500 font-bold opacity-0 uppercase animate-pulse">Data Incoming...</div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div id="status-txt" class="text-[9px] text-zinc-500 font-bold uppercase tracking-tighter">Connecting...</div>
                    <div id="node-id" class="text-[7px] text-zinc-700 font-mono">0x000000</div>
                </div>
                <div id="led" class="w-3 h-3 bg-zinc-800 rounded-full transition-all duration-500"></div>
            </div>
        </header>

        <main id="feed"></main>

        <footer class="p-6 bg-gradient-to-t from-black via-black/90 to-transparent z-50">
            <div class="max-w-5xl mx-auto glass p-5 rounded-3xl border border-zinc-800 shadow-2xl">
                <div id="reply-box" class="hidden mb-3 text-[10px] text-gold flex justify-between items-center bg-gold/10 p-2 rounded-lg border border-gold/20">
                    <span id="reply-info"></span><button onclick="offReply()" class="hover:text-white">‚úï</button>
                </div>
                <textarea id="msg-in" class="w-full bg-transparent text-white text-base h-24 outline-none resize-none p-2" placeholder="Synchronize thought... (/apex for root)"></textarea>
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-zinc-800/50">
                    <div class="flex gap-6 items-center">
                        <label class="cursor-pointer group flex flex-col items-center">
                            <svg class="w-6 h-6 text-zinc-500 group-hover:text-gold transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="2"></path></svg>
                            <span id="img-label" class="text-[8px] text-zinc-600 font-bold mt-1 uppercase">Media</span>
                            <input type="file" id="file-in" class="hidden" accept="image/*" onchange="loadImg()">
                        </label>
                    </div>
                    <button id="send-btn" onclick="sync()" class="btn-apex px-12 py-4 rounded-2xl text-xs uppercase shadow-xl">Synchronize</button>
                </div>
            </div>
        </footer>
    </div>

    <!-- 3: ROOT OVERSEER (Pass: admin999) -->
    <div id="scr-3" class="screen bg-black items-center justify-center">
        <div class="w-full max-w-sm border-2 border-red-900 p-12 glass text-center">
            <h2 class="text-red-600 font-black text-xs mb-10 tracking-[0.8em] uppercase">Overseer_Auth</h2>
            <input type="password" id="root-key" class="w-full bg-transparent border-b-2 border-red-900 text-red-500 text-5xl text-center outline-none mb-12 font-bold" placeholder="ROOT">
            <div class="flex gap-4">
                <button onclick="nav(2)" class="flex-1 text-zinc-600 text-xs font-bold uppercase hover:text-white">Abort</button>
                <button onclick="authRoot()" class="flex-[2] bg-red-900 text-white py-5 font-black tracking-widest active:scale-95 transition-all">VERIFY</button>
            </div>
        </div>
    </div>

    <script>
        // --- Á©∂Ê•µ„ÅÆ„Ç≥„Ç¢„Éª„É≠„Ç∏„ÉÉ„ÇØ ---
        const _CFG = { p: "neba72", r: "admin999" };
        let gun, db, imgRaw = "", repId = "", isRoot = false;

        function nav(n) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`scr-${n}`).classList.add('active');
        }

        // „Ç≤„Éº„ÉàÈÄöÈÅé
        function valGate() {
            if (document.getElementById('gate-in').value === _CFG.p) {
                nav(2); boot();
            } else { alert("ACCESS_DENIED"); location.reload(); }
        }

        function boot() {
            // Render„ÅÆËá™Ââç„É™„É¨„Éº„ÇíÂÑ™ÂÖà„ÄÅ‰∫àÂÇô„Å®„Åó„Å¶‰∏ñÁïåÂêÑÂú∞„ÅÆ„Éî„Ç¢„ÇíÁôªÈå≤
            const peers = [
                window.location.origin + '/gun',
                'https://gun-manhattan.herokuapp.com',
                'https://peer.wall.org'
            ];
            gun = Gun({ peers, localStorage: true });
            db = gun.get('apex_v20_ultimate_override');

            // ÂêåÊúüÈñãÂßã
            db.map().on((data, id) => {
                if (!data) { document.getElementById(id)?.remove(); return; }
                render(data, id);
            });

            // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
            document.getElementById('status-txt').innerText = "Signal_Stable";
            document.getElementById('led').className = "w-3 h-3 bg-green-500 rounded-full shadow-[0_0_15px_#22c55e]";
            document.getElementById('node-id').innerText = "NODE_" + Math.random().toString(16).slice(2, 8).toUpperCase();

            // „Ç≥„Éû„É≥„ÉâÁõ£Ë¶ñ
            document.getElementById('msg-in').addEventListener('input', (e) => {
                if (e.target.value === "/apex") { e.target.value = ""; nav(3); }
                document.getElementById('typing').style.opacity = e.target.value.length > 0 ? 1 : 0;
            });
        }

        function authRoot() {
            if (document.getElementById('root-key').value === _CFG.r) {
                isRoot = true; nav(2); alert("ROOT_ACCESS_GRANTED");
            } else { alert("DENIED"); }
        }

        // ÁîªÂÉèË∂ÖÂúßÁ∏Æ„Ç®„É≥„Ç∏„É≥ÔºàÂ≠¶Ê†°„Éï„Ç£„É´„Çø„Å®ÂÆπÈáèÂà∂Èôê„ÅÆÂêåÊôÇÁ™ÅÁ†¥Ôºâ
        function loadImg() {
            const f = document.getElementById('file-in').files[0];
            if (!f) return;
            document.getElementById('img-label').innerText = "COMPRESSING...";
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX = 500; // ÊúÄÈÅ©„Å™Ëß£ÂÉèÂ∫¶
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > MAX) { h *= MAX/w; w = MAX; } }
                    else { if (h > MAX) { w *= MAX/h; h = MAX; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    imgRaw = canvas.toDataURL('image/jpeg', 0.4); // 40%ÂúßÁ∏Æ
                    document.getElementById('img-label').innerText = "READY";
                    document.getElementById('img-label').classList.add('text-gold');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(f);
        }

        // ÈÄÅ‰ø°ÔºàÁÑ°Âà∂Èôê„ÉªÂç≥ÊôÇÂêåÊúüÔºâ
        function sync() {
            const msgIn = document.getElementById('msg-in');
            const btn = document.getElementById('send-btn');
            if (!msgIn.value.trim() && !imgRaw) return;

            btn.disabled = true;
            btn.innerText = "SYNCING...";

            const id = 'Z' + Date.now() + Math.random().toString(36).slice(2, 5);
            db.get(id).put({
                msg: msgIn.value,
                img: imgRaw,
                rep: repId,
                root: isRoot,
                ts: Date.now(),
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            }, (ack) => {
                // ÈÄÅ‰ø°ÂÆå‰∫ÜÂæå„ÅÆ„É™„Çª„ÉÉ„Éà
                msgIn.value = "";
                imgRaw = ""; repId = "";
                document.getElementById('img-label').innerText = "MEDIA";
                document.getElementById('img-label').classList.remove('text-gold');
                offReply();
                btn.disabled = false;
                btn.innerText = "Synchronize";
                document.getElementById('feed').scrollTop = 0;
            });
        }

        function render(data, id) {
            if (document.getElementById(id)) return;
            const f = document.getElementById('feed');
            const d = document.createElement('div');
            d.id = id;
            d.className = `post-box ${data.root ? 'admin-mode' : ''} animate-in fade-in slide-in-from-bottom-4 duration-500`;
            d.onclick = () => { repId = id; document.getElementById('reply-info').innerText = `RE_REFERENCE: ${id.slice(-4)}`; document.getElementById('reply-box').classList.remove('hidden'); document.getElementById('msg-in').focus(); };
            
            d.innerHTML = `
                <div class="flex justify-between items-center text-[8px] font-bold mb-4 opacity-40 uppercase tracking-widest">
                    <span>${data.root ? '‚òÖ ROOT_OVERSEER' : 'SIGNAL_NODE'} // ${data.time}</span>
                    ${isRoot ? `<button onclick="db.get('${id}').put(null)" class="text-red-500 hover:text-white transition-colors">TERMINATE</button>` : `<span>#${id.slice(-4)}</span>`}
                </div>
                ${data.rep ? `<div class="text-[8px] text-neon mb-2 font-bold opacity-60">>> REF: ${data.rep.slice(-4)}</div>` : ''}
                <div class="text-[13px] leading-relaxed break-words whitespace-pre-wrap font-sans text-zinc-100">${escapeHtml(data.msg || '')}</div>
                ${data.img ? `<img src="${data.img}" class="mt-4 rounded-xl w-full border border-zinc-800 shadow-2xl transition-all hover:scale-[1.01]" loading="lazy">` : ''}
                <div class="mt-4 flex gap-4 opacity-10 hover:opacity-100 transition-opacity">
                    <span class="text-[8px] cursor-pointer">REACT:üî•</span>
                    <span class="text-[8px] cursor-pointer">REACT:üëÅÔ∏è</span>
                </div>
            `;
            
            // ÊúÄÊñ∞„Çí‰∏ÄÁï™‰∏ä„Å∏ÊåøÂÖ•
            const children = Array.from(f.children);
            const ref = children.find(c => c.dataset.ts < data.ts);
            if (ref) f.insertBefore(d, ref); else f.appendChild(d);
            d.dataset.ts = data.ts;
        }

        function offReply() { repId = ""; document.getElementById('reply-box').classList.add('hidden'); }
        function escapeHtml(s) { return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    </script>
</body>
</html>
